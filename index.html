<!doctype html>
<html>
  <head>
    <title>Leaflet-TreeLayerControl</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/2.0.0-alpha.1/leaflet.css">
    <link rel="stylesheet" href="./css/boxicons.css">
    <link rel='icon' href='favicon.svg'>
    <style>
      html, body, #mapdiv {
        height: 100%;
        width: 100%;
        padding: 0px !important;
        margin: 0px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="mapdiv"></div>
    <!--
        "leaflet": "https://cdnjs.cloudflare.com/ajax/libs/leaflet/2.0.0-alpha.1/leaflet.js",
    -->
    <script type='importmap'>
    {
      "imports": {
        "leaflet": "../../libs/leaflet/src/leaflet.js",
        "LayersTree": "./LayersTree.mjs",
        "SVGMarker": "../SVGMarkers/SVGMarkers.mjs"
      }
    }
    </script>
    <script type="module">
      import { Map, Marker, TileLayer, GeoJSON, Tooltip } from 'leaflet';
      import { LayersTree } from 'LayersTree';
      import { SVGMarker } from 'SVGMarker';

      // Create a map in the "map" div, set the view to Dhaka, Bangladesh
      const map = new Map('mapdiv').setView([23.74, 90.38], 14);
      // add an OpenStreetMap tile layer
      const OSM = 'https://{s}.tile.osm.org/{z}/{x}/{y}.png';
      const basemap = new TileLayer(OSM);
      basemap.addTo(map);

      // This is a slow way to get data, but it's just a demo
      const askOSM = async function(query) {
          const customMarker = function(point, latlng) {
              let ptype = point.properties.type || "unknown";
              let guide = {
                  restaurant: {color:'black', glyph:'bx-fork-spoon'},
                  bar: {color:'black',glyph:'bx-beer'},
                  cafe: {color:'black', glyph:'bx-cup'},
                  pub: {color: 'black',glyph:'bx-beer',glyphColor:'yellow'},
                  hospital: {color:'red', glyph:'bx-cursor-cell'},
                  police: {color: 'white', glyph:'bx-man',glyphColor:'black'},
                  dentist: {color:'green', glyph:'bx-tooth'},
                  cinema: {glyph:'bx-video'},
                  theatre: {glyph:'bx-group'},
                  museum: {glyph:'bx-bank'},
              };
              let options = guide[ptype] || {};
              return new SVGMarker(latlng, options);
          }
          const area = map.getBounds();
          const sw = area.getSouthWest();
          const ne = area.getNorthEast();
          const viewbox = `${sw.lng},${sw.lat},${ne.lng},${ne.lat}`
          query = encodeURIComponent(query);
          const NOSM = 'https://nominatim.osm.org/search?format=geojson';
          const url = NOSM + `&bounded=1&viewbox=${viewbox}&amenity=${query}`
          let layer = null;
          try {
              let r = await fetch(url);
              if (r.ok) {
                  const j = await r.json();
                  let geojsonOptions = { pointToLayer: customMarker, }
                  layer = new GeoJSON(j, geojsonOptions); 
              } else {
                  console.log(await j.text());
              }
          } catch (e) { console.log(`${e.name}: ${e.message}`) }
          return layer;
      }

      // Categories: civil services (police, hospitals, post office)
      //             Food (bars, cafe, restaurant, fast-food)
      //             Shopping (a, b, c)
      //             Entertainment (cinema, park)

      // This is a slow way to get data, but it's just a demo
      const getSomeLayers = async function() {
          let overlays = {};
          const list = { 
              food: ["restaurant", "bar", "cafe"],
              civic: ["hospital", "dentist", "police" ],
              fun: [ "cinema", "museum", "theater" ],
          };
          for (let category in list) {
            for (let amenity of list[category]) {
              // Once we get "addGroup" figured out, we
              // can resolve the Promise instead of awaiting it.
              const layer = await askOSM(amenity);
              // Until we get categories figured out....
              if (layer) { 
                  layer._LTgroup = category;
                  overlays[amenity] = layer; 
              }
            }
          }

          // (sadly, very slowly) return an array of Layers
          // by repeatedly calling askOSM()
          return overlays;
      }

      // Display the map
      const center = map.getCenter();
      const banner = 'Looking up data for<br/><b>Dhaka, Bangladesh</b>';
      const tooltip = new Tooltip(center, {permanent: true, content: banner});
      // Something to read while we wait for OpenStreetMap.
      tooltip.addTo(map);
      const overlays = await getSomeLayers();
      const baselayers = { 'OpenStreetMap': basemap };
      tooltip.removeFrom(map);
      // So what we're passing is either an array, or an object like
      // { name1: layer1, name2: layer2, name3: layer3 }
      // So to maintain full compatibility _and_ get a tree structure, 
      // we need to decorate the layer with
      // hints as to where in the tree to put it.

      new LayersTree(baselayers, overlays).addTo(map);

      // Q: what happens if we add layers we've already added?
      // for (let key of Object.keys(overlays)) {
      //     overlays[key].addTo(map);
      // }
      // A:  Layer gets turned on

    </script>
  </body>
</html>


<!doctype html>
<html>
  <head>
    <title>Leaflet-TreeLayerControl</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@2.0.0-alpha.1/dist/leaflet.css" />
    <link rel="stylesheet" href="./css/boxicons.css">
    <link rel='icon' href='favicon.svg'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html, body, #mapdiv {
        height: 100%;
        width: 100%;
        padding: 0px !important;
        margin: 0px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="mapdiv"></div>
    <script type='importmap'>
    {
      "imports": {
        "leaflet": "https://cdn.jsdelivr.net/npm/leaflet@2.0.0-alpha.1/dist/leaflet.js",
        "LayersTree": "./LayersTree.mjs",
        "SVGMarker": "https://cdn.jsdelivr.net/npm/@almamigratoria/leaflet-svgmarkers/dist/js/SVGMarkers.min.mjs"
      }
    }
    </script>
    <script type="module">
      import { Map, Marker, TileLayer, GeoJSON, Tooltip } from 'leaflet';
      import { LayersTree } from 'LayersTree';
      import { SVGMarker } from 'SVGMarker';

      // Create a map in the "map" div, set the view to Dhaka, Bangladesh
      const map = new Map('mapdiv').setView([23.74, 90.38], 14);
      // add an OpenStreetMap tile layer
      const OSM = 'https://{s}.tile.osm.org/{z}/{x}/{y}.png';
      const basemap = new TileLayer(OSM);
      basemap.addTo(map);

      // This is a slow way to get data, but it's just a demo
      const askOSM = async function(query) {
          const customMarker = function(point, latlng) {
              let ptype = point.properties.type || "unknown";
              let guide = {
                  restaurant: {color:'black', glyph:'bx-fork-spoon'},
                  bar: {color:'black',glyph:'bx-beer'},
                  cafe: {color:'black', glyph:'bx-cup'},
                  pub: {color: 'black',glyph:'bx-beer',glyphColor:'yellow'},
                  hospital: {color:'red', glyph:'bx-cursor-cell'},
                  police: {color: 'white', glyph:'bx-man',glyphColor:'black'},
                  dentist: {color:'green', glyph:'bx-tooth'},
                  cinema: {glyph:'bx-video'},
                  theatre: {glyph:'bx-group'},
                  museum: {glyph:'bx-bank'},
                  bakery: {color:'black',glyph:'bx-cupcake'},
              };
              let options = guide[ptype] || {};
              return new SVGMarker(latlng, options);
          }
          const area = map.getBounds();
          const sw = area.getSouthWest();
          const ne = area.getNorthEast();
          const viewbox = `${sw.lng},${sw.lat},${ne.lng},${ne.lat}`
          query = encodeURIComponent(query);
          const NOSM = 'https://nominatim.osm.org/search?format=geojson';
          const url = NOSM + `&bounded=1&viewbox=${viewbox}&amenity=${query}`
          let layer = null;
          try {
              let r = await fetch(url);
              if (r.ok) {
                  const j = await r.json();
                  let geojsonOptions = { pointToLayer: customMarker, }
                  layer = new GeoJSON(j, geojsonOptions); 
              } else {
                  console.log(await j.text());
              }
          } catch (e) { console.log(`${e.name}: ${e.message}`) }
          return layer;
      }

      // Categories: civil services (police, hospitals, post office)
      //             Food (bars, cafe, restaurant, fast-food)
      //             Shopping (a, b, c)
      //             Entertainment (cinema, park)

      // This is a slow way to get data, but it's just a demo
      const getSomeLayers = async function() {
          let overlays = {};
          const list = { 
              food: ["restaurant", "bar", "cafe"],
              civic: ["hospital", "dentist", "police" ],
              fun: [ "cinema", "museum", "theater" ],
          };
          for (let category in list) {
            for (let amenity of list[category]) {
              const layer = await askOSM(amenity);
              if (layer) { 
                  layer._LTgroup = category;
                  overlays[amenity] = layer; 
              }
            }
          }

          // (sadly, very slowly) return an array of Layers
          // by repeatedly calling askOSM()
          return overlays;
      }

      // Display the map
      const center = map.getCenter();
      const banner = 'Looking up data for<br/><b>Dhaka, Bangladesh</b>';
      const tooltip = new Tooltip(center, {permanent: true, content: banner});
      // Something to read while we wait for OpenStreetMap.
      tooltip.addTo(map);
      const overlays = await getSomeLayers();
      const baselayers = { 'OpenStreetMap': basemap };
      tooltip.removeFrom(map);

      const LT = new LayersTree(baselayers, overlays);
      LT.addTo(map);

      // You can add layers to a group after it's added.
      const bakeries = await askOSM('bakery');
      bakeries._LTgroup = 'food';
      LT.addOverlay(bakeries, 'bakeries');

      // You don't _need_ to decorate the layers
      const bus_stops = await askOSM('bus_stop');
      LT.addOverlay(bus_stops, 'bus stops');

      // You can add new categories
      const car_rental = await askOSM('car_rental');
      car_rental._LTgroup = 'Rent a car';
      LT.addOverlay(car_rental, 'car rental');

    </script>
  </body>
</html>

